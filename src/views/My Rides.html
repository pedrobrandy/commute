<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Trips</title>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Load Header and Navigation Components -->
  <script src="../scripts/loadHeader.js"></script>
  <script src="../scripts/loadNav.js"></script>
  <script src="../scripts/loadCarousel.js"></script>
  <script src="../scripts/auth.js"></script>
  <script src="../config/config.production.js"></script>
  <script src="../scripts/api-utils.js"></script>

  <style>
    body {
      font-family: UberMove, UberMoveText, system-ui, "Helvetica Neue", Helvetica, Arial, sans-serif;
      margin: 0;
      background-color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 220px;
      /* Space for fixed header */
      padding-bottom: 150px;
      /* Space for bottom nav */
    }

    /* Wrapper del carrusel que contiene los botones fijos */
    .carousel-wrapper {
      position: relative;
      max-width: 90%;
      margin: 40px auto 0 auto;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Estilos para el carrusel de tarjetas en desktop */
    .carousel-container {
      display: flex;
      overflow-x: auto;
      gap: 20px;
      padding: 20px;
      scroll-behavior: smooth;
      flex: 1;
      position: relative;
      align-items: flex-start;
      flex-wrap: nowrap;
      min-height: 400px;
      box-sizing: border-box;
    }

    .carousel-container::-webkit-scrollbar {
      height: 8px;
    }

    .carousel-container::-webkit-scrollbar-track {
      background: #E0E1DD;
      border-radius: 4px;
    }

    .carousel-container::-webkit-scrollbar-thumb {
      background: #E0E1DD;
      border-radius: 4px;
    }

    .carousel-container::-webkit-scrollbar-thumb:hover {
      background: #1B263B;
    }

    .trip-card,
    .responsive-card {
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .trip-card {
      min-width: 300px;
      max-width: 350px;
      height: 438px;
      /* Fixed height for all cards */
      background: whitesmoke;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      padding: 19px;
      margin: 21px 0;
      transition: transform 0.3s ease, box-shadow 0.3s ease, height 0.3s ease;
      flex-shrink: 0;
      /* Prevent cards from shrinking */
      flex-grow: 0;
      /* Prevent cards from growing */
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      /* Distribute content evenly */
      box-sizing: border-box;
    }

    .trip-card.expanded {
      height: 800px;
      /* Expanded height when showing route details */
    }

    .trip-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .trip-card h3 {
      margin: 0 0 -7px 0;
      color: #415A77;
      font-size: 0.9rem;
      padding-bottom: 2px;
    }

    .trip-info {
      margin-bottom: 15px;
      flex: 1;
      /* Take available space */
    }

    .trip-info p {
      margin: 8px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 5px;
    }

    .trip-info .label {
      font-weight: 600;
      color: #1B263B;
      min-width: 80px;
    }

    .trip-info .value {
      color: #0D1B2A;
      text-align: right;
      flex: 1;
      margin-left: 10px;
    }

    .status-label {
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: 12px;
      background-color: #cbcbc8;
      color: #212529;
      font-weight: 500;
      white-space: nowrap;
      text-align: center;
      max-width: 120px;
      z-index: 10;
      margin-top: 4px;
    }

    /* Status label colors */
    .status-label[data-status="Negociación"] {
      background-color: #eaac8b !important;
      color: #212529 !important;
    }

    .status-label[data-status="Route_Assigned"] {
      background-color: #6d597a !important;
      color: #ffffff !important;
    }

    .status-label[data-status="Pre-Confirmado"] {
      background-color: #b56576 !important;
      color: #ffffff !important;
    }

    .status-label[data-status="Confirmed"] {
      background-color: #e56b6f !important;
      color: #ffffff !important;
    }

    .status-label[data-status="Route Confirmed"] {
      background-color: #355070 !important;
      color: #ffffff !important;
    }

    .status-label[data-status="No Aceptado"] {
      background-color: #355070 !important;
      color: #ffffff !important;
    }

    @media (min-width: 601px) {
      .status-label {
        margin-top: -18px;
        align-self: flex-start;
        margin-bottom: 0;
      }
    }

    @media (max-width: 600px) {
      .status-label {
        margin-top: 0;
        margin-bottom: 4px;
        align-self: flex-end;
      }
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: auto;
      /* Push to bottom */
      flex-shrink: 0;
      /* Prevent shrinking */
      position: relative;
      /* Ensure proper positioning */
    }

    .confirm-button {
      display: -webkit-inline-box;
      display: -moz-inline-box;
      display: -ms-inline-flexbox;
      display: -webkit-inline-flex;
      display: inline-flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      flex-direction: row;
      -webkit-box-align: center;
      align-items: center;
      -webkit-box-pack: center;
      justify-content: center;
      border-left-width: 0;
      border-top-width: 0;
      border-right-width: 0;
      border-bottom-width: 0;
      border-left-style: none;
      border-top-style: none;
      border-right-style: none;
      border-bottom-style: none;
      outline: none;
      box-shadow: none;
      text-decoration: none;
      -webkit-appearance: none;
      -webkit-transition-property: background;
      -moz-transition-property: background;
      transition-property: background;
      transition-duration: 200ms;
      transition-timing-function: cubic-bezier(0, 0, 1, 1);
      cursor: pointer;
      margin-left: 0;
      margin-top: 0;
      margin-right: 0;
      margin-bottom: 0;
      font-family: UberMoveText, system-ui, "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-size: 16px;
      font-weight: 500;
      line-height: 20px;
      border-top-right-radius: 8px;
      border-bottom-right-radius: 8px;
      border-top-left-radius: 8px;
      border-bottom-left-radius: 8px;
      padding-top: 14px;
      padding-bottom: 14px;
      padding-left: 25px;
      padding-right: 25px;
      color: #0D1B2A;
      background-color: #E0E1DD;
      min-width: 130px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .confirm-button.confirm {
      background-color: #E0E1DD;
      color: #0D1B2A;
    }

    .confirm-button.confirm:hover {
      background-color: #218838;
      color: white;
    }

    .cancel-button {
      display: -webkit-inline-box;
      display: -moz-inline-box;
      display: -ms-inline-flexbox;
      display: -webkit-inline-flex;
      display: inline-flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
      flex-direction: row;
      -webkit-box-align: center;
      align-items: center;
      -webkit-box-pack: center;
      justify-content: center;
      border-left-width: 0;
      border-top-width: 0;
      border-right-width: 0;
      border-bottom-width: 0;
      border-left-style: none;
      border-top-style: none;
      border-right-style: none;
      border-bottom-style: none;
      outline: none;
      box-shadow: none;
      text-decoration: none;
      -webkit-appearance: none;
      -webkit-transition-property: background;
      -moz-transition-property: background;
      transition-property: background;
      transition-duration: 200ms;
      transition-timing-function: cubic-bezier(0, 0, 1, 1);
      cursor: pointer;
      margin-left: 0;
      margin-top: 0;
      margin-right: 0;
      margin-bottom: 0;
      font-family: UberMoveText, system-ui, "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-size: 16px;
      font-weight: 500;
      line-height: 20px;
      border-top-right-radius: 8px;
      border-bottom-right-radius: 8px;
      border-top-left-radius: 8px;
      border-bottom-left-radius: 8px;
      padding-top: 14px;
      padding-bottom: 14px;
      padding-left: 25px;
      padding-right: 25px;
      color: #E0E1DD;
      background-color: #1B263B;
      min-width: 130px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .cancel-button:hover {
      background-color: #c82333;
      color: white;
    }

    /* Estilos para la tabla (solo en móvil) */
    .table-container {
      display: none;
    }

    /* Ocultar tarjetas responsive en desktop */
    #cardContainer {
      display: none;
    }

    th,
    td {
      padding: 5px 16px;
      border-bottom: 1px solid #0D1B2A;
      text-align: center;
    }

    th {
      background-color: #778DA9;
      color: #E0E1DD;
    }

    table {
      width: 100%;
      margin: 10px auto;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .notice {
      font-size: 0.9rem;
      color: #777;
      text-align: center;
      margin-top: -35px;
    }

    /* Responsive para móvil */
    @media (max-width: 768px) {
      .carousel-container {
        display: none;
        /* Hide carousel on mobile */
      }

      .carousel-controls {
        display: none;
      }

      /* Hide carousel navigation buttons on mobile */
      .carousel-btn {
        display: none !important;
      }

      .table-container {
        display: none;
      }

      /* Mostrar tarjetas responsive solo en móvil */
      #cardContainer {
        display: block;
        margin-top: 20px;
        /* Added top margin for mobile */
      }

      .responsive-card {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin: 10px;
        padding: 15px;
        background: whitesmoke;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        position: relative;
        height: 400px;
        /* Fixed height for mobile cards - same as desktop */
        justify-content: space-between;
        /* Distribute content evenly */
        box-sizing: border-box;
        transition: transform 0.3s ease, box-shadow 0.3s ease, height 0.3s ease;
      }

      .responsive-card.expanded {
        height: 800px;
        /* Expanded height when showing route details */
      }

      .responsive-card .card-header {
        margin-bottom: 10px;
        gap: 15px;
      }

      .responsive-card .left-column {
        gap: 10px;
        min-width: 80px;
      }

      .responsive-card .right-column {
        gap: 6px;
      }

      .responsive-card .ride-type-icon {
        width: 100px !important;
        height: 100px !important;
      }

      .responsive-card .ride-type-title {
        font-size: 1.1rem;
      }

      .responsive-card .date-time-info {
        gap: 4px;
      }

      .responsive-card .date-row,
      .responsive-card .time-row {
        height: 25px;
      }

      .responsive-card .date-text {
        font-size: 0.8rem;
      }

      .responsive-card .date-icon,
      .responsive-card .time-icon {
        height: 20px;
        width: 20px;
      }

      .responsive-card .price-section {
        padding: 6px 10px;
        margin-top: 2px;
      }

      .responsive-card .trip-price {
        font-size: 18px;
        margin: 0;
      }

      .status-label {
        top: 4px;
        right: 6px;
        font-size: 0.75rem;
        padding: 3px 7px;
      }

      .card-top-row {
        min-height: 32px;
      }

      .van-img {
        height: 22px;
      }

      .responsive-card .route-image {
        height: 74px;
        width: auto;
      }

      .responsive-card .address-value {
        font-size: 0.85rem;
      }
    }

    /* Desktop styles - ensure carousel is visible */
    @media (min-width: 769px) {
      .carousel-container {
        display: flex !important;
        /* Force display on desktop */
      }

      .carousel-btn {
        display: flex !important;
        /* Force display on desktop */
      }
    }

    /* Controles del carrusel */
    .carousel-controls {
      display: none;
    }

    .carousel-btn {
      background: #E0E1DD;
      color: #0D1B2A;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.3s ease;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      pointer-events: auto;
      flex-shrink: 0;
      /* Prevent buttons from shrinking */
    }

    .carousel-btn:hover {
      background: #778DA9;
      transform: scale(1.1);
    }

    .carousel-btn:disabled {
      background: rgba(204, 204, 204, 0.5);
      cursor: not-allowed;
      transform: scale(1);
    }

    /* Ensure buttons are visible and clickable */
    .carousel-btn i {
      color: #0D1B2A;
      font-size: 16px;
    }

    .van-img-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 8px 0 4px 0;
    }

    .van-img {
      height: 40px;
      width: auto;
      display: block;
    }

    /* Fila superior de la tarjeta: fecha, imagen y status label */
    .card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 15px;
      width: 100%;
      flex-shrink: 0;
      /* Prevent shrinking */
    }

    .left-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      min-width: 100px;
      flex-shrink: 0;
    }

    .right-column {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
    }

    .ride-type-title {
      margin: 0;
      color: #415A77;
      font-size: 1.3rem;
      font-weight: 600;
      background: #E0E1DD;
      border-radius: 12px;
      text-align: center;
      margin-top: 10px;
    }

    .date-time-info {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .price-section {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-width: 120px;
      flex-shrink: 0;
      background: #E0E1DD;
      border-radius: 12px;
      padding: 4px 6px;
      margin-top: 4px;
    }

    .trip-price {
      color: #415A77;
      text-align: left;
      font-family: UberMove, UberMoveText, system-ui, "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-size: 20px;
      font-weight: 600;
      margin: 0;
      width: auto;
      display: block;
      z-index: 2;
      white-space: nowrap;
    }

    .card-top-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-top: 8px;
      width: 100%;
      flex-shrink: 0;
      /* Prevent shrinking */
    }

    .card-date {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      flex: 1 1 0;
      min-width: 0;
    }

    .right-info-col {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
      min-width: 110px;
      flex-shrink: 0;
      /* Prevent shrinking */
    }

    .date-row,
    .time-row {
      display: flex;
      align-items: center;
      gap: 4px;
      height: 30px;
      color: #415A77
    }

    .date-text {
      font-size: 0.85rem;
      color: #415A77;
      white-space: nowrap;
    }

    .date-icon,
    .time-icon {
      height: 26px;
      width: 26px;
      display: inline-block;
      filter: invert(30%) sepia(11%) saturate(1360%) hue-rotate(175deg) brightness(93%) contrast(91%);
      color: #415A77
    }

    .card-time {
      font-size: 0.85em;
      color: #415A77;
      margin-top: 0;
      font-weight: 400;
    }

    .van-img {
      margin: 0 auto;
      height: 32px;
      z-index: 1;
      display: block;
    }

    .trip-address-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin: -20px 0 14px 0;
      flex: 1;
      /* Take available space */
    }

    .address-block {
      display: flex;
      align-items: center;
      gap: 2px;
      min-width: 0;
    }

    .address-value {
      font-size: 0.9rem;
      color: #415A77;
      font-weight: 400;
      max-width: 140px;
      overflow-wrap: break-word;
      word-break: break-word;
      white-space: normal;
    }

    .route-image {
      height: 106px;
      width: auto;
      display: block;
      filter: invert(19%) sepia(17%) saturate(1380%) hue-rotate(202deg) brightness(92%) contrast(92%);

    }

    /* Agrega este CSS para el detalle expandido */
    .route-details {
      margin: 0px 0;
      flex-shrink: 0;
    }

    .route-details-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
    }

    .route-details-table th,
    .route-details-table td {
      border-bottom: 1px solid #e0e0e0;
      padding: 4px 6px;
      text-align: left;
      font-size: 0.97em;
    }

    .route-details-table th {
      background: #e0e1dd;
      color: #0D1B2A;
      font-weight: 600;
    }

    .bottom-nav {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      background: #415A77;
      border-bottom: 1.5px solid #E0E1DD;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
      padding: 0;
      min-height: 68px;
    }

    .bottom-menu {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 40px;
      list-style: none;
      margin: 0;
      padding: 0;
      flex: 1;
    }

    .bottom-menu li {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
    }

    .bottom-menu a {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      color: #E0E1DD;
      font-weight: 500;
      font-size: 13px;
      padding: 0;
      background: none;
      border: none;
    }

    .nav-icon {
      width: 33px;
      height: 33px;
      margin-bottom: 2px;
      display: block;
      filter: none;
    }

    .nav-label {
      font-size: 11px;
      color: #E0E1DD;
      text-align: center;
      margin-top: 0px;
      font-weight: 500;
      letter-spacing: 0.01em;
    }

    .user-info {
      position: absolute;
      right: 18px;
      top: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logout-btn {
      background: #E0E1DD;
      color: #1B263B;
      border: none;
      border-radius: 4px;
      padding: 4px 12px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-left: 4px;
      transition: background 0.2s;
    }

    .logout-btn:hover {
      background: #778DA9;
      color: #fff;
    }

    @media (max-width: 600px) {
      .bottom-nav {
        top: auto;
        bottom: 0;
        border-top: 1.5px solid #E0E1DD;
        border-bottom: none;
        min-height: 60px;
        padding: 0;
      }

      .bottom-menu {
        gap: 18px;
      }

      .nav-icon {
        width: 33px;
        height: 33px;
      }

      .nav-label {
        font-size: 10px;
      }

      .user-info {
        position: fixed;
        top: 10px;
        right: 10px;
        left: auto;
        z-index: 101;
      }
    }

    /* Filter for Rides and Contact icons to match text color */
    .bottom-menu li:first-child .nav-icon,
    .bottom-menu li:last-child .nav-icon {
      filter: brightness(0) saturate(100%) invert(89%) sepia(6%) saturate(247%) hue-rotate(202deg) brightness(94%) contrast(90%);
    }

    /* Additional spacing for mobile to prevent nav overlap */
    @media (max-width: 600px) {
      #cardContainer {
        margin-bottom: 50px;
        /* Reduced space for bottom navigation */
      }

      .notice {
        margin-bottom: 50px;
        /* Reduced space for bottom navigation */
      }

      .table-container {
        margin-bottom: 50px;
        /* Space for bottom navigation */
      }

      .carousel-container {
        margin-bottom: 50px;
        /* Space for bottom navigation */
      }
    }

    @media (max-width: 768px) {
      .card-top-row {
        flex-direction: row;
        align-items: flex-start;
        gap: 6px;
      }

      .right-info-col {
        min-width: 80px;
      }

      .trip-price {
        font-size: 20px;
      }

      .status-label {
        font-size: 0.75rem;
        padding: 3px 8px;
        max-width: 90vw;
      }
    }

    /* Playlist Section Styles */
    .playlist-section {
      margin: 40px auto;
      max-width: 800px;
      padding: 0 20px;
    }

    .playlist-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .playlist-title {
      color: #1B263B;
      margin: 0 0 10px 0;
      font-size: 1.8rem;
      font-weight: 600;
    }

    .playlist-subtitle {
      color: #666;
      margin: 0 0 20px 0;
      font-size: 1rem;
    }

    .playlist-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .playlist-btn {
      background: #1B263B;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      text-decoration: none;
      transition: background-color 0.3s ease;
    }

    .playlist-btn:hover {
      background: #415A77;
    }

    .playlist-btn.secondary {
      background: #415A77;
    }

    .playlist-btn.secondary:hover {
      background: #1B263B;
    }

    .playlist-link {
      color: #007bff;
      text-decoration: none;
      font-size: 0.9rem;
      transition: color 0.3s ease;
    }

    .playlist-link:hover {
      color: #0056b3;
    }

    .playlist-iframe {
      border: none;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      width: 100%;
      height: 400px;
      display: none;
    }

    /* New styles for playlist list within cards */
    .playlist-list-container {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-top: 15px;
      border: 1px solid #e9ecef;
    }

    .playlist-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .playlist-list-title {
      margin: 0;
      color: #1B263B;
      font-size: 1.2rem;
    }

    .playlist-list-controls {
      display: flex;
      gap: 10px;
    }

    .playlist-list-btn {
      background: #1B263B;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .playlist-list-btn:hover {
      background: #415A77;
      transform: translateY(-1px);
    }

    .playlist-list-btn.secondary {
      background: #415A77;
    }

    .playlist-list-btn.secondary:hover {
      background: #1B263B;
    }

    .playlist-iframe-container {
      margin-bottom: 15px;
    }

    .playlist-search-container {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid #dee2e6;
    }

    .search-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }

    .search-input {
      padding: 10px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 14px;
    }

    .search-input:focus {
      outline: none;
      border-color: #1B263B;
      box-shadow: 0 0 0 2px rgba(27, 38, 59, 0.25);
    }

    .search-btn {
      background: #1B263B;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .search-btn:hover {
      background: #415A77;
      transform: translateY(-1px);
    }

    .search-results {
      max-height: 300px;
      overflow-y: auto;
    }

    .your-stops-container {
      background: white;
      border-radius: 8px;
      padding: 15px;
      border: 1px solid #dee2e6;
      margin-top: 15px;
    }

    .your-stops-container h5 {
      margin: 0 0 15px 0;
      color: #1B263B;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .stops-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .stop-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #1B263B;
    }

    .stop-time {
      background: #1B263B;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      min-width: 60px;
      text-align: center;
    }

    .stop-location {
      flex: 1;
      font-weight: 600;
      color: #1B263B;
      font-size: 0.9rem;
    }

    .stop-type {
      background: #415A77;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .playlist-loading {
      text-align: center;
      color: #666;
      padding: 20px;
      font-style: italic;
    }

    .playlist-songs-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .playlist-song-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-bottom: 1px solid #eee;
      transition: background-color 0.2s ease;
    }

    .playlist-song-item:hover {
      background-color: #f8f9fa;
    }

    .playlist-song-item:last-child {
      border-bottom: none;
    }

    .playlist-song-info {
      flex: 1;
      min-width: 0;
    }

    .playlist-song-title {
      font-weight: 600;
      color: #1B263B;
      font-size: 0.9rem;
      margin-bottom: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .playlist-song-channel {
      color: #666;
      font-size: 0.8rem;
    }

    .playlist-song-link {
      padding: 6px 12px;
      background: #1B263B;
      color: white !important;
      border-radius: 4px;
      font-size: 0.8rem;
      text-decoration: none;
      transition: background-color 0.2s ease;
    }

    .playlist-song-link:hover {
      background: #415A77;
    }

    @media (max-width: 768px) {
      .route-details {
        grid-template-columns: 1fr;
      }

      .playlist-list-controls {
        flex-direction: column;
        gap: 5px;
      }

      .search-form {
        flex-direction: column;
      }

      .stop-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .stop-time {
        align-self: flex-start;
      }
    }
  </style>
</head>

<body>

  <!-- Header will be loaded here by loadHeader.js -->
  <!-- Navigation will be loaded here by loadNav.js -->

  <!-- Carrusel de tarjetas para desktop -->
  <div class="carousel-wrapper" id="carouselWrapper">
    <!-- Botón Previous -->
    <button class="carousel-btn prev" onclick="scrollCarousel('left')" id="leftBtn">
      <i class="fas fa-chevron-left"></i>
    </button>

    <!-- Contenedor del carrusel (scrollable) -->
    <div class="carousel-container" id="carouselContainer">
      <!-- Las tarjetas se generarán dinámicamente -->
    </div>

    <!-- Botón Next -->
    <button class="carousel-btn next" onclick="scrollCarousel('right')" id="rightBtn">
      <i class="fas fa-chevron-right"></i>
    </button>
  </div>

  <!-- Tabla para móvil -->
  <div class="table-container">
    <table id="tripTable">
      <thead>
        <tr>
          <th onclick="ordenarPorFecha()">Date 🔽</th>
          <th>Origin</th>
          <th>Destination</th>
          <th style="text-align: center">Price</th>
          <th style="text-align: center">Status</th>
          <th style="text-align: center">Action</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rellenado con JS -->
      </tbody>
    </table>
  </div>

  <div id="cardContainer"></div>

  <p class="notice">Only upcoming or active trips are listed here.</p>

  <!-- Carrusel de sugerencias -->
  <div id="carousel-container"></div>

  <script>
    function toggleUserMenu() {
      document.querySelector(".user-info").classList.toggle("mobile-active");
    }

    function logout() {
      localStorage.clear();
      window.location.href = "Login.html";
    }

    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
      window.location.href = 'Login.html';
    }

    const email = user.email;
    console.log("Email en localStorage:", email);

    const scriptUrl = CONFIG.GOOGLE_APPS_SCRIPT.MAIN;
    const proxyUrl = scriptUrl;

    // Initialize API Utils
    const apiUtils = new APIUtils(scriptUrl);

    // Alternative CORS proxy if needed
    const corsProxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(scriptUrl);

    // Function to make API calls with CORS fallback
    async function makeApiCall(url, options = {}) {
      try {
        // Use the new APIUtils class for better CORS handling
        return await apiUtils.makeApiCall(url, options);
      } catch (error) {
        console.error('API call failed:', error);
        throw error;
      }
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString(undefined, { day: '2-digit', month: 'short', year: 'numeric' });
    }

    // Function to get ride type image
    function getRideTypeImage(tripType) {
      if (tripType === 'Shared Ride') {
        return 'https://pedrobrandy.github.io/commute/image/ShareRideIcon.png';
      } else if (tripType === 'Personal Ride') {
        return 'https://pedrobrandy.github.io/commute/image/PersonalRideIcon.png';
      }
      return ''; // Return empty string if no match
    }

    // Fixed function to generate action buttons
    function generateActionButtons(trip) {
      const status = trip.status.toLowerCase().trim();
      console.log(`Generating buttons for status: "${status}"`);

      let buttons = '';

      if (status === 'confirmed') {
        return `<span style="color: #778DA9; font-weight: bold;">Your reservatios in confirmed we are waiting for the rest of the passengers.</span>`;
      } else if (status === 'negociación') {
        buttons = `
        <button
          class="confirm-button confirm"
          title="Clicking confirms you accept and pre-confirm – please only click once."
          onclick="updateStatus('${trip.id}', 'Pre-Confirmado')">
          Pre‑Confirm
        </button>
      `;
      } else if (status.includes('route') && status.includes('assigned')) {
        buttons = `
        <button
          class="confirm-button confirm"
          title="Clicking confirms you accept the details – please only click once."
          onclick="updateStatus('${trip.id}', 'Confirmed')">
          Confirm
        </button>
      `;
      }

      // Don't show cancel button for Route_Confirmed status
      if (status !== 'route_confirmed') {
        buttons += `
      <button
        class="cancel-button"
        title="Clicking Cancel you will not recover this trip – please only click once."
        onclick="updateStatus('${trip.id}', 'Canceled')">
        Cancel
      </button>
    `;
      }

      return buttons;
    }

    // Función para crear tarjeta de viaje
    function createTripCard(trip) {
      let routeDetailLink = '';
      const routeId = trip.routeId || trip.routeID;
      if (routeId) {
        routeDetailLink = `<a class="route-detail-link" href="route_detail.html?routeId=${encodeURIComponent(routeId)}&name=${encodeURIComponent(trip.name)}" target="_blank" style="display:inline-block;margin:10px 0 0 0;color:#0078D4;font-weight:600;text-decoration:underline;">Ver más detalle</a>`;
      }

      // Check if status is Route_Confirmed to show playlist
      const showPlaylist = trip.status === 'Route_Confirmed' || trip.status === 'Confirmed';
      const playlistContainer = showPlaylist ? `
      <div class="playlist-list-container" id="playlist-container-${trip.id}">
        <div class="playlist-list-header">
          <h4 class="playlist-list-title">🎵 Commute Playlist</h4>
          <div class="playlist-list-controls">
            <button onclick="togglePlaylistSearch('${trip.id}')" class="playlist-list-btn">🎵 Add Songs</button>
            <button onclick="refreshPlaylist('${trip.id}')" class="playlist-list-btn">🔄 Refresh</button>
          </div>
        </div>

        <!-- YouTube Playlist List (not video) -->
        <div class="playlist-list-container" id="playlist-list-${trip.id}">
          <div class="playlist-loading">Loading playlist...</div>
        </div>

        <!-- Search Interface (hidden by default) -->
        <div class="playlist-search-container" id="playlist-search-${trip.id}" style="display: none;">
          <div class="search-form">
            <input type="text" id="search-input-${trip.id}" placeholder="Search for a song..." class="search-input">
            <input type="text" id="user-name-${trip.id}" placeholder="Your name" class="search-input">
            <button onclick="searchAndSubmitSong('${trip.id}')" class="search-btn">Search & Submit</button>
          </div>
          <div id="search-results-${trip.id}" class="search-results"></div>
        </div>

        <!-- Your Stops Section -->
        <div class="your-stops-container">
          <h5>📍 Your Stops</h5>
          <div class="stops-list">
            <div class="stop-item">
              <span class="stop-time">${trip.timeText || 'TBD'}</span>
              <span class="stop-location">${trip.origin}</span>
              <span class="stop-type">Pickup</span>
            </div>
            <div class="stop-item">
              <span class="stop-time">${trip.timeText ? addMinutes(trip.timeText, 30) : 'TBD'}</span>
              <span class="stop-location">${trip.destination}</span>
              <span class="stop-type">Dropoff</span>
            </div>
          </div>
        </div>
      </div>
    ` : '';

      return `
      <div class="trip-card">
        <div class="card-top-row">
          <span class="card-date">
            <span class="date-row">
              <img src="https://www.svgrepo.com/show/438428/date-round.svg" class="date-icon" alt="date" />
              ${formatDate(trip.startDate)}
            </span>
            <span class="time-row">
              <img src="https://static.vecteezy.com/system/resources/previews/017/259/098/non_2x/clock-icon-time-sign-free-png.png" class="time-icon" alt="time" />
              <span class="card-time">${trip.timeText || ''}</span>
            </span>
          </span>
          <span class="right-info-col">
            <div class="status-label" id="statusLabel-${trip.id}" data-status="${trip.status}">${trip.status}</div>
            <span class="trip-price">${trip.price} CAD</span>
          </span>
        </div>
        <div class="trip-address-row">
          <span class="address-block">
            <span class="address-value">${trip.origin}</span>
          </span>
          <img src="../../public/image/Ruta.png" class="route-image" alt="route" />
          <span class="address-block">
            <span class="address-value">${trip.destination}</span>
          </span>
        </div>
        <div class="route-details" style="display:none;"></div>
        ${playlistContainer}
        <div class="action-buttons">
          ${generateActionButtons(trip)}
        </div>
      </div>
    `;
    }

    // Función para hacer scroll del carrusel
    function scrollCarousel(direction) {
      console.log('scrollCarousel called with direction:', direction);
      const container = document.getElementById('carouselContainer');

      if (!container) {
        console.error('Carousel container not found!');
        return;
      }

      console.log('Container found:', container);
      console.log('Container scrollLeft:', container.scrollLeft);
      console.log('Container scrollWidth:', container.scrollWidth);
      console.log('Container clientWidth:', container.clientWidth);
      console.log('Container children count:', container.children.length);

      // Check if there are cards to scroll
      const cards = container.querySelectorAll('.trip-card');
      console.log('Number of trip cards found:', cards.length);

      if (cards.length === 0) {
        console.log('No cards found to scroll');
        return;
      }

      // Calculate scroll amount based on card width + gap
      const cardWidth = cards[0].offsetWidth;
      const gap = 20; // This should match the gap in CSS
      const scrollAmount = cardWidth + gap;

      console.log('Card width:', cardWidth);
      console.log('Scroll amount:', scrollAmount);

      if (direction === 'left') {
        console.log('Scrolling left by:', scrollAmount);
        container.scrollBy({
          left: -scrollAmount,
          behavior: 'smooth'
        });
      } else {
        console.log('Scrolling right by:', scrollAmount);
        container.scrollBy({
          left: scrollAmount,
          behavior: 'smooth'
        });
      }

      // Log the new scroll position after a short delay
      setTimeout(() => {
        console.log('New scroll position:', container.scrollLeft);
        console.log('Max scroll position:', container.scrollWidth - container.clientWidth);
      }, 100);
    }

    (async () => {
      try {
        // First, test if the Google Apps Script is accessible
        console.log('Testing Google Apps Script connection...');

        let testData;
        try {
          testData = await makeApiCall(`${proxyUrl}?action=test`);
          console.log('Google Apps Script test successful:', testData);
        } catch (testError) {
          console.error('Google Apps Script test failed:', testError);

          let errorMessage = 'Error: Cannot connect to Google Apps Script.\n\n';
          errorMessage += 'Error: ' + testError.message + '\n\n';
          errorMessage += 'SOLUTION:\n';
          errorMessage += '1. Go to Google Apps Script\n';
          errorMessage += '2. Click "Deploy" > "New deployment"\n';
          errorMessage += '3. Set "Execute as": Me\n';
          errorMessage += '4. Set "Who has access": Anyone\n';
          errorMessage += '5. Deploy and update the URL in config.production.js\n';

          alert(errorMessage);

          // Show fallback content with instructions
          const container = document.getElementById('carouselContainer');
          if (container) {
            container.innerHTML = `
            <div style="text-align: center; padding: 40px; max-width: 600px; margin: 0 auto;">
              <h3 style="color: #d32f2f; margin-bottom: 20px;">🚫 Google Apps Script Connection Error</h3>
              <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; text-align: left; margin-bottom: 20px;">
                <h4>Error:</h4>
                <p><strong>Message:</strong> ${testError.message}</p>
              </div>
              <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; text-align: left;">
                <h4>🔧 How to Fix:</h4>
                <ol style="text-align: left;">
                  <li>Go to <a href="https://script.google.com/" target="_blank">Google Apps Script</a></li>
                  <li>Open your project</li>
                  <li>Click "Deploy" → "New deployment"</li>
                  <li>Set "Execute as": <strong>Me</strong></li>
                  <li>Set "Who has access": <strong>Anyone</strong></li>
                  <li>Click "Deploy"</li>
                  <li>Copy the new URL and update <code>config.production.js</code></li>
                </ol>
              </div>
              <div style="margin-top: 20px;">
                <button onclick="location.reload()" style="padding: 10px 20px; background: #1B263B; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                  🔄 Retry
                </button>
                <button onclick="loadSampleData()" style="padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                  📋 Show Sample Data
                </button>
                <button onclick="testRawResponse().then(result => console.log('Raw response test:', result))" style="padding: 10px 20px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                  🔍 Test Raw Response
                </button>
                <a href="diagnose-network.html" style="padding: 10px 20px; background: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block;">
                  🔧 Run Diagnostics
                </a>
              </div>
            </div>
          `;
          }

          return;
        }

        const data = await makeApiCall(`${proxyUrl}?route=registro&action=ver_todos&status=all`);
        console.log("Datos recibidos:", data);

        if (!data.success) throw new Error(data.error);

        const userEmail = email;
        const trips = data.results.filter(t => {
          console.log("Filtrando viaje:", t);

          if (t.email !== userEmail) {
            console.log(`Email no coincide: ${t.email} !== ${userEmail}`);
            return false;
          }

          if (t.status.toLowerCase() === "cancelado" || t.status.toLowerCase() === "canceled") {
            console.log("Viaje cancelado, no se muestra:", t);
            return false;
          }

          const tripDate = new Date(t.startDate);
          const now = new Date();
          tripDate.setHours(0, 0, 0, 0);
          now.setHours(0, 0, 0, 0);

          return tripDate >= now;
        });

        const tbody = document.querySelector("#tripTable tbody");
        const cardContainer = document.getElementById("cardContainer");
        const carouselContainer = document.getElementById("carouselContainer");

        tbody.innerHTML = '';
        cardContainer.innerHTML = '';

        // Clear only the carousel container content (not the wrapper)
        carouselContainer.innerHTML = '';

        if (trips.length === 0) {
          tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#888;">No upcoming trips found</td></tr>`;
          const noTripsDiv = document.createElement('div');
          noTripsDiv.style.cssText = 'text-align:center; color:#888; padding: 40px; width: 100%;';
          noTripsDiv.textContent = 'No upcoming trips found';
          carouselContainer.appendChild(noTripsDiv);
          return;
        }

        trips.forEach(trip => {
          console.log(`Processing trip with status: "${trip.status}"`);

          // Crear fila para tabla móvil
          const row = document.createElement("tr");
          row.innerHTML = `
          <td style="white-space: nowrap;">${formatDate(trip.startDate)}</td>
          <td style="white-space: nowrap;">${trip.origin}</td>
          <td style="white-space: nowrap;">${trip.destination}</td>
          <td style="white-space: nowrap;">${trip.price} CAD</td>
          <td>
            <div class="buttons-container">
              <span id="statusLabel-${trip.id}" class="status-label" data-status="${trip.status}">${trip.status}</span>
            </div>
          </td>
          <td>
            <div class="action-buttons">
              ${generateActionButtons(trip)}
            </div>
          </td>
        `;
          tbody.appendChild(row);

          // Crear tarjeta para carrusel desktop
          console.log('Creating trip card for carousel...');
          const tripCard = renderTripCard(trip);
          console.log('Trip card created:', tripCard);
          carouselContainer.appendChild(tripCard);
          console.log('Trip card added to carousel');

          // Load playlist songs if status allows it
          if (trip.status === 'Route_Confirmed' || trip.status === 'Confirmed') {
            setTimeout(() => {
              loadPlaylistSongs(trip.id);
            }, 100);
          }

          // Crear tarjeta responsive para móvil
          const rideTypeImage = getRideTypeImage(trip.type);
          const rideTypeImageHtml = rideTypeImage ? `<img src="${rideTypeImage}" class="ride-type-icon" alt="ride type" style="width: 100px; height: 100px; transform: scaleX(-1);" />` : '';
          const rideTypeTitle = trip.type === 'Shared Ride' ? 'Shared Ride' : 'Personal Ride';

          // Check if status is Route_Confirmed to show playlist
          const showPlaylist = trip.status === 'Route_Confirmed' || trip.status === 'Confirmed';
          const playlistContainer = showPlaylist ? `
          <div class="playlist-list-container" id="playlist-container-mobile-${trip.id}">
            <div class="playlist-list-header">
              <h4 class="playlist-list-title">🎵 Commute Playlist</h4>
              <div class="playlist-list-controls">
                <button onclick="togglePlaylistSearch('mobile-${trip.id}')" class="playlist-list-btn">🎵 Add Songs</button>
                <button onclick="refreshPlaylist('mobile-${trip.id}')" class="playlist-list-btn">🔄 Refresh</button>
              </div>
            </div>

            <!-- YouTube Playlist List (not video) -->
            <div class="playlist-list-container" id="playlist-list-${trip.id}">
              <div class="playlist-loading">Loading playlist...</div>
            </div>

            <!-- Search Interface (hidden by default) -->
            <div class="playlist-search-container" id="playlist-search-mobile-${trip.id}" style="display: none;">
              <div class="search-form">
                <input type="text" id="search-input-mobile-${trip.id}" placeholder="Search for a song..." class="search-input">
                <input type="text" id="user-name-mobile-${trip.id}" placeholder="Your name" class="search-input">
                <button onclick="searchAndSubmitSong('mobile-${trip.id}')" class="search-btn">Search & Submit</button>
              </div>
              <div id="search-results-mobile-${trip.id}" class="search-results"></div>
            </div>

            <!-- Your Stops Section -->
            <div class="your-stops-container">
              <h5>📍 Your Stops</h5>
              <div class="stops-list">
                <div class="stop-item">
                  <span class="stop-time">${trip.timeText || 'TBD'}</span>
                  <span class="stop-location">${trip.origin}</span>
                  <span class="stop-type">Pickup</span>
                </div>
                <div class="stop-item">
                  <span class="stop-time">${trip.timeText ? addMinutes(trip.timeText, 30) : 'TBD'}</span>
                  <span class="stop-location">${trip.destination}</span>
                  <span class="stop-type">Dropoff</span>
                </div>
              </div>
            </div>
          </div>
        ` : '';

          const card = document.createElement("div");
          card.className = "responsive-card";
          card.innerHTML = `
          <div class="card-header">
            <div class="left-column">
              ${rideTypeImageHtml}
              <div class="status-label" id="statusLabel-${trip.id}" data-status="${trip.status}">${trip.status}</div>
            </div>
            <div class="right-column">
              <h3 class="ride-type-title">${rideTypeTitle}</h3>
              <div class="date-time-info">
                <div class="date-row">
                  <img src="https://www.svgrepo.com/show/438428/date-round.svg" class="date-icon" alt="date" />
                  <span class="date-text">${formatDate(trip.startDate)}</span>
                </div>
                <div class="time-row">
                  <img src="https://static.vecteezy.com/system/resources/previews/017/259/098/non_2x/clock-icon-time-sign-free-png.png" class="time-icon" alt="time" />
                  <span class="card-time">${trip.timeText || ''}</span>
                </div>
                <div class="price-section">
                  <span class="trip-price">$${trip.price} CAD</span>
                </div>
              </div>
            </div>
          </div>
          <div class="trip-address-row">
            <span class="address-block">
              <span class="address-value">${trip.origin}</span>
            </span>
            <img src="../../public/image/Ruta.png" class="route-image" alt="route" />
            <span class="address-block">
              <span class="address-value">${trip.destination}</span>
            </span>
          </div>
          <div class="route-details" style="display:none;"></div>
          ${playlistContainer}
          <div class="action-buttons">
            ${generateActionButtons(trip)}
          </div>
        `;
          cardContainer.appendChild(card);

          // Load playlist songs for mobile cards if status allows it
          if (trip.status === 'Route_Confirmed' || trip.status === 'Confirmed') {
            setTimeout(() => {
              loadPlaylistSongs(trip.id);
            }, 100);
          }

          // Add click event listener for responsive cards (mobile)
          card.addEventListener('click', async function (e) {
            // Evita que los botones de acción disparen el despliegue
            if (e.target.closest('.action-buttons')) return;

            console.log('Responsive card clicked:', trip);

            // Estados que permiten ver los detalles de ruta
            const routeDetailStates = [
              'Route_Assigned', 'Ruta Asignada', 'Confirmed', 'Confirmado',
              'Route Confirmed', 'Ruta Confirmada', 'Pending Payment', 'Pendiente Pago',
              'Paid', 'Pagado', 'Done'
            ];

            const shouldShowRouteDetails = routeDetailStates.some(state => {
              const matches = trip.status.toLowerCase().includes(state.toLowerCase());
              return matches;
            });

            console.log('Should show route details:', shouldShowRouteDetails);

            // Si el estado permite ver detalles de ruta, mostrar la información directamente
            if (shouldShowRouteDetails) {
              console.log('=== ENTERING ROUTE DETAILS LOGIC (MOBILE) ===');
              const detailsDiv = card.querySelector('.route-details');

              if (detailsDiv.style.display === 'block') {
                console.log('Details already shown, hiding...');
                detailsDiv.style.display = 'none';
                detailsDiv.innerHTML = '';
                card.classList.remove('expanded'); // Remove expanded class
                return;
              }

              console.log('Showing route details directly in responsive card');
              detailsDiv.style.display = 'block';
              detailsDiv.innerHTML = '<div style="text-align:center; color:#888;">Loading route details...</div>';
              card.classList.add('expanded'); // Add expanded class

              try {
                // Obtener datos de reservaciones y route assignments
                const [reservationsData, routeData] = await Promise.all([
                  makeApiCall(`${proxyUrl}?route=registro&action=ver_todos&status=all`),
                  makeApiCall(`${proxyUrl}?route=Route_Assignment&action=ver_todos`)
                ]);

                console.log('Reservations data:', reservationsData);
                console.log('Route data:', routeData);

                if (!reservationsData.success || !routeData.success) {
                  throw new Error(`API Error: Reservations: ${reservationsData.message}, Routes: ${routeData.message}`);
                }

                // Encontrar la reservación del usuario
                console.log('Looking for user reservation with email:', email);
                console.log('Trip data:', trip);

                // Buscar la reservación específica que corresponde a esta tarjeta
                let userReservation = null;

                // Primero intentar buscar por ID exacto
                userReservation = reservationsData.results.find(r => r.id === trip.id);
                console.log('Reservation found by ID:', userReservation);

                // Si no se encuentra por ID, buscar por createdAt (routeId)
                if (!userReservation && trip.createdAt) {
                  userReservation = reservationsData.results.find(r =>
                    r.email === email &&
                    r.createdAt === trip.createdAt &&
                    r.status === 'Route_Assigned'
                  );
                  console.log('Reservation found by createdAt:', userReservation);
                }

                // Si aún no se encuentra, buscar por routeId
                if (!userReservation && trip.routeId) {
                  userReservation = reservationsData.results.find(r =>
                    r.email === email &&
                    r.routeId === trip.routeId &&
                    r.status === 'Route_Assigned'
                  );
                  console.log('Reservation found by routeId:', userReservation);
                }

                // Si aún no se encuentra, buscar cualquier reservación Route_Assigned del usuario
                if (!userReservation) {
                  userReservation = reservationsData.results.find(r =>
                    r.email === email &&
                    r.status === 'Route_Assigned' &&
                    r.createdAt && r.createdAt.startsWith('Route')
                  );
                  console.log('Reservation found by status Route_Assigned:', userReservation);
                }

                console.log('Final user reservation found:', userReservation);

                if (!userReservation) {
                  detailsDiv.innerHTML = '<div style="color:red;">User reservation not found</div>';
                  return;
                }

                // Determinar el routeId
                const routeId = userReservation.routeId || userReservation.createdAt;
                console.log('Using routeId:', routeId);

                if (!routeId) {
                  detailsDiv.innerHTML = '<div style="color:red;">No route ID found for this reservation</div>';
                  return;
                }

                // Obtener TODAS las asignaciones de esta ruta
                const allRouteAssignments = routeData.results.filter(r => r.routeId === routeId);
                console.log('All route assignments for routeId:', routeId, 'Count:', allRouteAssignments.length);

                if (allRouteAssignments.length === 0) {
                  detailsDiv.innerHTML = '<div style="color:red;">No route assignments found for this route</div>';
                  return;
                }

                // Ordenar por timePickDrop para obtener el orden correcto de las paradas
                const sortedRouteAssignments = allRouteAssignments.sort((a, b) => {
                  const timeA = new Date(a.timePickDrop || 0);
                  const timeB = new Date(b.timePickDrop || 0);
                  return timeA - timeB;
                });

                // Encontrar todas las paradas de este usuario en esta ruta
                const userStops = sortedRouteAssignments
                  .map((assignment, index) => ({
                    ...assignment,
                    stopNumber: index + 1,
                    formattedTimePickDrop: formatTimePickDrop(assignment.timePickDrop)
                  }))
                  .filter(assignment => assignment.name === userReservation.name);

                console.log('User stops found:', userStops);

                if (userStops.length === 0) {
                  detailsDiv.innerHTML = '<div style="color:red;">No route assignments found for this user</div>';
                  return;
                }

                // Mostrar las paradas del usuario
                let stopsHtml = '<div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-top: 15px;">';
                stopsHtml += '<h4 style="margin: 0 0 15px 0; color: #1B263B; font-size: 1.1em;">Your Route Stops:</h4>';

                for (const stop of userStops) {
                  stopsHtml += `
                  <div style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 8px; border-left: 3px solid #1B263B; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="font-weight: 600; color: #1B263B; margin-bottom: 5px; font-size: 0.95em;">
                      Stop ${stop.stopNumber}: ${stop.origin || 'Not specified'}
                    </div>
                    <div style="font-size: 0.85em; color: #666; line-height: 1.4;">
                      Duration: ${stop.duration || 'Not specified'} | Time: ${stop.formattedTimePickDrop}
                    </div>
                  </div>
                `;
                }

                stopsHtml += '</div>';
                detailsDiv.innerHTML = stopsHtml;

                console.log('=== ROUTE DETAILS SUCCESSFULLY LOADED (MOBILE) ===');
                console.log('HTML content set:', stopsHtml);

              } catch (err) {
                console.error('Error loading route details:', err);
                detailsDiv.innerHTML = '<div style="color:red;">Error loading route details</div>';
              }
              console.log('=== EXITING ROUTE DETAILS LOGIC (MOBILE) ===');
              return;
            }

            console.log('Using original behavior for status:', trip.status);
            // Comportamiento original para otros estados
            const detailsDiv = card.querySelector('.route-details');
            if (detailsDiv.style.display === 'block') {
              detailsDiv.style.display = 'none';
              detailsDiv.innerHTML = '';
              card.classList.remove('expanded'); // Remove expanded class
              return;
            }
            const routeId = trip.routeId || trip.routeID;
            if (!routeId) return;
            detailsDiv.style.display = 'block';
            detailsDiv.innerHTML = '<div style="text-align:center; color:#888;">Loading route details...</div>';
            card.classList.add('expanded'); // Add expanded class
            // Fetch de la API para Route_Assignment
            try {
              const data = await makeApiCall(`${proxyUrl}?route=Route_Assignment&action=ver_todos&routeId=${encodeURIComponent(routeId)}`);
              if (data.success && data.results && data.results.length) {
                detailsDiv.innerHTML = createRouteDetailsTable(data.results);
              } else {
                detailsDiv.innerHTML = '<div>No route details found.</div>';
              }
            } catch (err) {
              detailsDiv.innerHTML = '<div style="color:red;">Error loading route details</div>';
            }
          });
        });

        // Log carousel info after loading
        console.log('Carousel container children:', carouselContainer.children.length);
        console.log('Carousel scrollWidth:', carouselContainer.scrollWidth);
        console.log('Carousel clientWidth:', carouselContainer.clientWidth);

        // Check for trip cards specifically
        const tripCards = carouselContainer.querySelectorAll('.trip-card');
        console.log('Trip cards found in carousel:', tripCards.length);

        if (tripCards.length > 0) {
          console.log('First trip card dimensions:', {
            offsetWidth: tripCards[0].offsetWidth,
            offsetHeight: tripCards[0].offsetHeight,
            clientWidth: tripCards[0].clientWidth,
            clientHeight: tripCards[0].clientHeight
          });
        }

      } catch (err) {
        console.error("Error cargando viajes:", err);
        alert("Error loading trips: " + err.message);
      }
    })();
  </script>

  <script>
    async function updateStatus(tripId, newStatus) {
      let confirmMessage = "Are you sure?";

      if (newStatus === 'Cancelado') {
        confirmMessage = "Are you sure you want to cancel this trip?";
      } else if (newStatus === 'Pre-Confirmado') {
        confirmMessage = "Are you sure you want to pre-confirm this trip?";
      } else if (newStatus === 'Confirmed') {
        confirmMessage = "Are you sure you want to confirm this trip?";
      }

      if (!confirm(confirmMessage)) return;

      const scriptUrl = CONFIG.GOOGLE_APPS_SCRIPT.MAIN;

      const formData = `route=registro&action=actualizar_estado&id=${encodeURIComponent(tripId)}&status=${encodeURIComponent(newStatus)}`;

      try {
        const responseData = await makeApiCall(proxyUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: formData
        });

        // Mostrar la respuesta del servidor para depuración
        alert(JSON.stringify(responseData));
        location.reload();

      } catch (err) {
        console.error("Error updating status:", err);
        location.reload();
      }
    }

    let ordenDescendente = true;

    function ordenarPorFecha() {
      const tbody = document.querySelector("#tripTable tbody");
      const rows = Array.from(tbody.querySelectorAll("tr"));

      rows.sort((a, b) => {
        const fechaA = new Date(a.children[0].textContent);
        const fechaB = new Date(b.children[0].textContent);
        return ordenDescendente ? fechaB - fechaA : fechaA - fechaB;
      });

      ordenDescendente = !ordenDescendente;

      rows.forEach(row => tbody.appendChild(row));
    }

    function createRouteDetailsTable(assignments) {
      if (!assignments.length) return '<div>No route details found.</div>';
      let html = `<table class="route-details-table">
    <thead><tr>
      <th>routeId</th><th>startDate</th><th>timeValue</th><th>name</th><th>origin</th><th>duration</th><th>timePickDrop</th>
    </tr></thead><tbody>`;
      for (const a of assignments) {
        html += `<tr>
      <td>${a.routeId || ''}</td>
      <td>${a.startDate || ''}</td>
      <td>${a.timeValue || ''}</td>
      <td>${a.name || ''}</td>
      <td>${a.origin || ''}</td>
      <td>${a.duration || ''}</td>
      <td>${a.timePickDrop || ''}</td>
    </tr>`;
      }
      html += '</tbody></table>';
      return html;
    }

    function renderTripCard(trip) {
      const rideTypeImage = getRideTypeImage(trip.type);
      const rideTypeImageHtml = rideTypeImage ? `<img src="${rideTypeImage}" class="ride-type-icon" alt="ride type" style="width: 100px; height: 100px; transform: scaleX(-1);" />` : '';
      const rideTypeTitle = trip.type === 'Shared Ride' ? 'Shared Ride' : 'Personal Ride';

      // Estados que permiten ver los detalles de ruta
      const routeDetailStates = [
        'Route_Assigned', 'Ruta Asignada', 'Confirmed', 'Confirmado',
        'Route Confirmed', 'Ruta Confirmada', 'Pending Payment', 'Pendiente Pago',
        'Paid', 'Pagado', 'Done'
      ];

      console.log('Checking trip status:', trip.status);
      console.log('Route detail states:', routeDetailStates);

      const shouldShowRouteDetails = routeDetailStates.some(state => {
        const matches = trip.status.toLowerCase().includes(state.toLowerCase());
        console.log(`Checking "${trip.status}" against "${state}": ${matches}`);
        return matches;
      });

      console.log('Should show route details:', shouldShowRouteDetails);

      // Check if status is Route_Confirmed to show playlist
      const showPlaylist = trip.status === 'Route_Confirmed' || trip.status === 'Confirmed';
      const playlistContainer = showPlaylist ? `
    <div class="playlist-list-container" id="playlist-container-${trip.id}">
      <div class="playlist-list-header">
        <h4 class="playlist-list-title">🎵 Commute Playlist</h4>
        <div class="playlist-list-controls">
          <button onclick="togglePlaylistSearch('${trip.id}')" class="playlist-list-btn">🎵 Add Songs</button>
          <button onclick="refreshPlaylist('${trip.id}')" class="playlist-list-btn">🔄 Refresh</button>
        </div>
      </div>

      <!-- YouTube Playlist List (not video) -->
      <div class="playlist-list-container" id="playlist-list-${trip.id}">
        <div class="playlist-loading">Loading playlist...</div>
      </div>

      <!-- Search Interface (hidden by default) -->
      <div class="playlist-search-container" id="playlist-search-${trip.id}" style="display: none;">
        <div class="search-form">
          <input type="text" id="search-input-${trip.id}" placeholder="Search for a song..." class="search-input">
          <input type="text" id="user-name-${trip.id}" placeholder="Your name" class="search-input">
          <button onclick="searchAndSubmitSong('${trip.id}')" class="search-btn">Search & Submit</button>
        </div>
        <div id="search-results-${trip.id}" class="search-results"></div>
      </div>

      <!-- Your Stops Section -->
      <div class="your-stops-container">
        <h5>📍 Your Stops</h5>
        <div class="stops-list">
          <div class="stop-item">
            <span class="stop-time">${trip.timeText || 'TBD'}</span>
            <span class="stop-location">${trip.origin}</span>
            <span class="stop-type">Pickup</span>
          </div>
          <div class="stop-item">
            <span class="stop-time">${trip.timeText ? addMinutes(trip.timeText, 30) : 'TBD'}</span>
            <span class="stop-location">${trip.destination}</span>
            <span class="stop-type">Dropoff</span>
          </div>
        </div>
      </div>
    </div>
  ` : '';

      const wrapper = document.createElement('div');
      wrapper.className = 'trip-card';
      wrapper.innerHTML = `
    <div class="card-header">
      <div class="left-column">
        ${rideTypeImageHtml}
        <div class="status-label" id="statusLabel-${trip.id}" data-status="${trip.status}">${trip.status}</div>
      </div>
      <div class="right-column">
        <h3 class="ride-type-title">${rideTypeTitle}</h3>
        <div class="date-time-info">
          <div class="date-row">
            <img src="https://www.svgrepo.com/show/438428/date-round.svg" class="date-icon" alt="date" />
            <span class="date-text">${formatDate(trip.startDate)}</span>
          </div>
          <div class="time-row">
            <img src="https://static.vecteezy.com/system/resources/previews/017/259/098/non_2x/clock-icon-time-sign-free-png.png" class="time-icon" alt="time" />
            <span class="card-time">${trip.timeText || ''}</span>
          </div>
          <div class="price-section">
            <span class="trip-price">$${trip.price} CAD</span>
          </div>
        </div>
      </div>
    </div>
    <div class="trip-address-row">
      <span class="address-block">
        <span class="address-value">${trip.origin}</span>
      </span>
      <img src="../../public/image/Ruta.png" class="route-image" alt="route" />
      <span class="address-block">
        <span class="address-value">${trip.destination}</span>
      </span>
    </div>
    <div class="route-details" style="display:none;"></div>
    ${playlistContainer}
    <div class="action-buttons">
      ${generateActionButtons(trip)}
    </div>
  `;

      // Click para expandir/cerrar detalles o mostrar información de ruta
      wrapper.addEventListener('click', async function (e) {
        // Evita que los botones de acción disparen el despliegue
        if (e.target.closest('.action-buttons')) return;

        console.log('Card clicked:', trip);
        console.log('Should show route details:', shouldShowRouteDetails);

        // Si el estado permite ver detalles de ruta, mostrar la información directamente
        if (shouldShowRouteDetails) {
          console.log('=== ENTERING ROUTE DETAILS LOGIC ===');
          const detailsDiv = wrapper.querySelector('.route-details');

          if (detailsDiv.style.display === 'block') {
            console.log('Details already shown, hiding...');
            detailsDiv.style.display = 'none';
            detailsDiv.innerHTML = '';
            wrapper.classList.remove('expanded'); // Remove expanded class
            return;
          }

          console.log('Showing route details directly in card');
          detailsDiv.style.display = 'block';
          detailsDiv.innerHTML = '<div style="text-align:center; color:#888;">Loading route details...</div>';
          wrapper.classList.add('expanded'); // Add expanded class

          try {
            // Obtener datos de reservaciones y route assignments
            const [reservationsData, routeData] = await Promise.all([
              makeApiCall(`${proxyUrl}?route=registro&action=ver_todos&status=all`),
              makeApiCall(`${proxyUrl}?route=Route_Assignment&action=ver_todos`)
            ]);

            console.log('Reservations data:', reservationsData);
            console.log('Route data:', routeData);

            if (!reservationsData.success || !routeData.success) {
              throw new Error(`API Error: Reservations: ${reservationsData.message}, Routes: ${routeData.message}`);
            }

            // Encontrar la reservación del usuario
            console.log('Looking for user reservation with email:', email);
            console.log('Trip data:', trip);

            // Buscar la reservación específica que corresponde a esta tarjeta
            let userReservation = null;

            // Primero intentar buscar por ID exacto
            userReservation = reservationsData.results.find(r => r.id === trip.id);
            console.log('Reservation found by ID:', userReservation);

            // Si no se encuentra por ID, buscar por createdAt (routeId)
            if (!userReservation && trip.createdAt) {
              userReservation = reservationsData.results.find(r =>
                r.email === email &&
                r.createdAt === trip.createdAt &&
                r.status === 'Route_Assigned'
              );
              console.log('Reservation found by createdAt:', userReservation);
            }

            // Si aún no se encuentra, buscar por routeId
            if (!userReservation && trip.routeId) {
              userReservation = reservationsData.results.find(r =>
                r.email === email &&
                r.routeId === trip.routeId &&
                r.status === 'Route_Assigned'
              );
              console.log('Reservation found by routeId:', userReservation);
            }

            // Si aún no se encuentra, buscar cualquier reservación Route_Assigned del usuario
            if (!userReservation) {
              userReservation = reservationsData.results.find(r =>
                r.email === email &&
                r.status === 'Route_Assigned' &&
                r.createdAt && r.createdAt.startsWith('Route')
              );
              console.log('Reservation found by status Route_Assigned:', userReservation);
            }

            console.log('Final user reservation found:', userReservation);

            if (!userReservation) {
              detailsDiv.innerHTML = '<div style="color:red;">User reservation not found</div>';
              return;
            }

            // Determinar el routeId
            const routeId = userReservation.routeId || userReservation.createdAt;
            console.log('Using routeId:', routeId);

            if (!routeId) {
              detailsDiv.innerHTML = '<div style="color:red;">No route ID found for this reservation</div>';
              return;
            }

            // Obtener TODAS las asignaciones de esta ruta
            const allRouteAssignments = routeData.results.filter(r => r.routeId === routeId);
            console.log('All route assignments for routeId:', routeId, 'Count:', allRouteAssignments.length);

            if (allRouteAssignments.length === 0) {
              detailsDiv.innerHTML = '<div style="color:red;">No route assignments found for this route</div>';
              return;
            }

            // Ordenar por timePickDrop para obtener el orden correcto de las paradas
            const sortedRouteAssignments = allRouteAssignments.sort((a, b) => {
              const timeA = new Date(a.timePickDrop || 0);
              const timeB = new Date(b.timePickDrop || 0);
              return timeA - timeB;
            });

            // Encontrar todas las paradas de este usuario en esta ruta
            const userStops = sortedRouteAssignments
              .map((assignment, index) => ({
                ...assignment,
                stopNumber: index + 1,
                formattedTimePickDrop: formatTimePickDrop(assignment.timePickDrop)
              }))
              .filter(assignment => assignment.name === userReservation.name);

            console.log('User stops found:', userStops);

            if (userStops.length === 0) {
              detailsDiv.innerHTML = '<div style="color:red;">No route assignments found for this user</div>';
              return;
            }

            // Mostrar las paradas del usuario
            let stopsHtml = '<div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-top: 15px;">';
            stopsHtml += '<h4 style="margin: 0 0 15px 0; color: #1B263B; font-size: 1.1em;">Your Route Stops:</h4>';

            for (const stop of userStops) {
              stopsHtml += `
            <div style="margin-bottom: 15px; padding: 12px; background: white; border-radius: 8px; border-left: 3px solid #1B263B; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
              <div style="font-weight: 600; color: #1B263B; margin-bottom: 5px; font-size: 0.95em;">
                Stop ${stop.stopNumber}: ${stop.origin || 'Not specified'}
              </div>
              <div style="font-size: 0.85em; color: #666; line-height: 1.4;">
                Duration: ${stop.duration || 'Not specified'} | Time: ${stop.formattedTimePickDrop}
              </div>
            </div>
          `;
            }

            stopsHtml += '</div>';
            detailsDiv.innerHTML = stopsHtml;

            console.log('=== ROUTE DETAILS SUCCESSFULLY LOADED ===');
            console.log('HTML content set:', stopsHtml);

          } catch (err) {
            console.error('Error loading route details:', err);
            detailsDiv.innerHTML = '<div style="color:red;">Error loading route details</div>';
          }
          console.log('=== EXITING ROUTE DETAILS LOGIC ===');
          return;
        }

        console.log('Using original behavior for status:', trip.status);
        // Comportamiento original para otros estados
        const detailsDiv = wrapper.querySelector('.route-details');
        if (detailsDiv.style.display === 'block') {
          detailsDiv.style.display = 'none';
          detailsDiv.innerHTML = '';
          wrapper.classList.remove('expanded'); // Remove expanded class
          return;
        }
        const routeId = wrapper.routeId || wrapper.routeID;
        if (!routeId) return;
        detailsDiv.style.display = 'block';
        detailsDiv.innerHTML = '<div style="text-align:center; color:#888;">Loading route details...</div>';
        wrapper.classList.add('expanded'); // Add expanded class
        // Fetch de la API para Route_Assignment
        try {
          const data = await makeApiCall(`${proxyUrl}?route=Route_Assignment&action=ver_todos&routeId=${encodeURIComponent(routeId)}`);
          if (data.success && data.results && data.results.length) {
            detailsDiv.innerHTML = createRouteDetailsTable(data.results);
          } else {
            detailsDiv.innerHTML = '<div>No route details found.</div>';
          }
        } catch (err) {
          detailsDiv.innerHTML = '<div style="color:red;">Error loading route details</div>';
        }
      });
      return wrapper;
    }

    // Función para formatear la hora de timePickDrop
    function formatTimePickDrop(timePickDrop) {
      if (!timePickDrop) return 'Not specified';

      try {
        // Si ya está en formato legible (ej: "5:30"), devolverlo tal como está
        if (typeof timePickDrop === 'string' && timePickDrop.match(/^\d{1,2}:\d{2}$/)) {
          return timePickDrop;
        }

        // Si es una fecha ISO, convertirla a formato legible
        const date = new Date(timePickDrop);
        if (!isNaN(date.getTime())) {
          const hours = date.getHours();
          const minutes = date.getMinutes();
          return `${hours}:${minutes.toString().padStart(2, '0')}`;
        }

        return timePickDrop;
      } catch (error) {
        console.error('Error formatting timePickDrop:', error);
        return timePickDrop;
      }
    }

    // Function to add minutes to time string
    function addMinutes(timeStr, minutes) {
      if (!timeStr) return 'TBD';

      // Parse time (assuming format like "08:30 AM" or "14:30")
      let time = timeStr;
      let isPM = false;

      // Handle AM/PM format
      if (timeStr.includes('AM') || timeStr.includes('PM')) {
        isPM = timeStr.includes('PM');
        time = timeStr.replace(/\s*(AM|PM)/i, '');
      }

      const [hours, mins] = time.split(':').map(Number);
      let totalMinutes = hours * 60 + mins;

      // Add the specified minutes
      totalMinutes += minutes;

      // Convert back to hours and minutes
      const newHours = Math.floor(totalMinutes / 60);
      const newMins = totalMinutes % 60;

      // Format the result
      if (isPM || timeStr.includes('AM') || timeStr.includes('PM')) {
        // 12-hour format
        const displayHours = newHours > 12 ? newHours - 12 : newHours;
        const ampm = newHours >= 12 ? 'PM' : 'AM';
        return `${displayHours.toString().padStart(2, '0')}:${newMins.toString().padStart(2, '0')} ${ampm}`;
      } else {
        // 24-hour format
        return `${newHours.toString().padStart(2, '0')}:${newMins.toString().padStart(2, '0')}`;
      }
    }

    // Function to toggle playlist search interface
    function togglePlaylistSearch(tripId) {
      const searchContainer = document.getElementById(`playlist-search-${tripId}`);
      const listContainer = document.getElementById(`playlist-list-${tripId}`);

      if (searchContainer.style.display === 'none') {
        searchContainer.style.display = 'block';
        listContainer.style.display = 'none';
      } else {
        searchContainer.style.display = 'none';
        listContainer.style.display = 'block';
      }
    }

    // Function to refresh playlist list
    function refreshPlaylist(tripId) {
      loadPlaylistSongs(tripId);
    }

    // Function to load playlist songs as a list
    async function loadPlaylistSongs(tripId) {
      const listContainer = document.getElementById(`playlist-list-${tripId}`);

      try {
        // Show loading
        listContainer.innerHTML = '<div class="playlist-loading">Loading playlist...</div>';

        // Fetch playlist items from YouTube API
        const response = await fetch(
          `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=PLdGwROaOdT_TtRuGfBKJbM9EL2EFdg_6c&key=${CONFIG.YOUTUBE_API_KEY}&maxResults=10`
        );

        const data = await response.json();

        if (data.error) {
          throw new Error(data.error.message);
        }

        if (!data.items || data.items.length === 0) {
          listContainer.innerHTML = '<div class="playlist-loading">No songs in playlist yet</div>';
          return;
        }

        // Display playlist as a list
        let html = '<div class="playlist-songs-list">';

        data.items.forEach((item, index) => {
          const thumbnail = item.snippet.thumbnails.default || item.snippet.thumbnails.medium;
          const videoId = item.snippet.resourceId.videoId;
          const youtubeUrl = `https://www.youtube.com/watch?v=${videoId}`;

          html += `
        <div class="playlist-song-item">
          <img src="${thumbnail.url}" alt="${item.snippet.title}" style="width: 60px; height: 45px; border-radius: 4px; object-fit: cover;">
          <div class="playlist-song-info">
            <div class="playlist-song-title">${item.snippet.title}</div>
            <div class="playlist-song-channel">${item.snippet.channelTitle}</div>
            </div>
          <a href="${youtubeUrl}" target="_blank" class="playlist-song-link" style="color: #1B263B; text-decoration: none; font-size: 0.8rem;">▶️ Play</a>
        </div>
      `;
        });

        html += '</div>';
        listContainer.innerHTML = html;

      } catch (error) {
        console.error('Error loading playlist:', error);
        listContainer.innerHTML = '<div class="playlist-loading">Error loading playlist</div>';
      }
    }

    // Función para cargar la playlist de YouTube
    function loadPlaylist() {
      const playlistId = CONFIG.YOUTUBE.PLAYLIST_ID;
      const iframe = document.getElementById('playlistIframe');
      const errorDiv = document.getElementById('playlistError');

      if (playlistId && playlistId !== 'YOUR_PLAYLIST_ID_HERE') {
        try {
          iframe.src = `https://www.youtube.com/embed/videoseries?list=${playlistId}`;
          iframe.style.display = 'block';
          errorDiv.style.display = 'none';

          // Verificar si el iframe se carga correctamente
          iframe.onload = function () {
            console.log('Playlist loaded successfully');
          };

          iframe.onerror = function () {
            console.error('Error loading playlist');
            iframe.style.display = 'none';
            errorDiv.style.display = 'block';
          };

        } catch (error) {
          console.error('Error setting playlist URL:', error);
          iframe.style.display = 'none';
          errorDiv.style.display = 'block';
        }
      } else {
        iframe.style.display = 'none';
        errorDiv.style.display = 'block';
        console.warn('Playlist ID not configured');
      }
    }

    // Cargar la playlist cuando la página se carga
    document.addEventListener('DOMContentLoaded', function () {
      // Load playlist songs for any Route_Confirmed cards
      const playlistContainers = document.querySelectorAll('.playlist-list-container');
      playlistContainers.forEach(container => {
        const tripId = container.id.replace('playlist-container-', '').replace('playlist-container-mobile-', '');
        loadPlaylistSongs(tripId);
      });
    });

    // Function to test Google Apps Script deployment
    async function testGoogleAppsScript() {
      const testUrl = `${proxyUrl}?action=test`;
      console.log('Testing Google Apps Script at:', testUrl);

      try {
        // Try to get the raw response first
        const response = await fetch(testUrl, { mode: 'no-cors' });
        console.log('Raw response type:', response.type);

        if (response.type === 'opaque') {
          console.log('Response is opaque - CORS issue detected');
          return {
            success: false,
            error: 'CORS_ERROR',
            message: 'Google Apps Script is accessible but CORS is blocking the response. Please check deployment settings.'
          };
        }
      } catch (error) {
        console.log('No-cors test failed:', error);
      }

      // Try with CORS proxy
      try {
        const corsProxyUrl = `https://cors-anywhere.herokuapp.com/${testUrl}`;
        const response = await fetch(corsProxyUrl);
        const text = await response.text();
        console.log('CORS proxy response:', text);

        try {
          const data = JSON.parse(text);
          return { success: true, data };
        } catch (parseError) {
          return {
            success: false,
            error: 'INVALID_JSON',
            message: 'Google Apps Script returned invalid JSON: ' + text.substring(0, 200),
            rawResponse: text
          };
        }
      } catch (error) {
        return {
          success: false,
          error: 'NETWORK_ERROR',
          message: 'Cannot connect to Google Apps Script: ' + error.message
        };
      }
    }

    // Function to load sample data for demonstration
    function loadSampleData() {
      console.log('Loading sample data for demonstration...');

      const user = JSON.parse(localStorage.getItem('user')) || { name: 'Test User', email: 'test@example.com' };

      // Sample data that matches the expected structure
      const sampleData = {
        success: true,
        results: [
          {
            id: 1,
            type: "Personal Ride",
            startDate: "2025-01-15",
            timeText: "08:30 AM",
            origin: "Toronto",
            destination: "Mississauga",
            status: "Confirmed",
            price: 45,
            name: user.name || "Test User",
            email: user.email,
            routeId: "Route_20250115_001",
            createdAt: "Route_20250115_001"
          },
          {
            id: 2,
            type: "Shared Ride",
            startDate: "2025-01-16",
            timeText: "09:15 AM",
            origin: "Brampton",
            destination: "Toronto",
            status: "Route_Assigned",
            price: 25,
            name: user.name || "Test User",
            email: user.email,
            routeId: "Route_20250116_002",
            createdAt: "Route_20250116_002"
          },
          {
            id: 3,
            type: "Personal Ride",
            startDate: "2025-01-17",
            timeText: "07:15 AM",
            origin: "Scarborough",
            destination: "Markham",
            status: "Pre-Confirmado",
            price: 35,
            name: user.name || "Test User",
            email: user.email,
            routeId: "Route_20250117_003",
            createdAt: "Route_20250117_003"
          },
          {
            id: 4,
            type: "Shared Ride",
            startDate: "2025-01-18",
            timeText: "10:30 AM",
            origin: "Mississauga",
            destination: "Brampton",
            status: "Negociación",
            price: 20,
            name: user.name || "Test User",
            email: user.email,
            routeId: "Route_20250118_004",
            createdAt: "Route_20250118_004"
          }
        ]
      };

      // Process the sample data using the same logic as real data
      const userEmail = user.email;
      const trips = sampleData.results.filter(t => {
        console.log("Filtrando viaje de ejemplo:", t);

        if (t.email !== userEmail) {
          console.log(`Email no coincide: ${t.email} !== ${userEmail}`);
          return false;
        }

        if (t.status.toLowerCase() === "cancelado" || t.status.toLowerCase() === "canceled") {
          console.log("Viaje cancelado, no se muestra:", t);
          return false;
        }

        const tripDate = new Date(t.startDate);
        const now = new Date();
        tripDate.setHours(0, 0, 0, 0);
        now.setHours(0, 0, 0, 0);

        return tripDate >= now;
      });

      // Clear containers
      tbody.innerHTML = '';
      cardContainer.innerHTML = '';
      carouselContainer.innerHTML = '';

      // Make cardContainer visible for sample data
      cardContainer.style.display = 'block';
      console.log('Made cardContainer visible for sample data');

      if (trips.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:#888;">No upcoming trips found</td></tr>`;
        const noTripsDiv = document.createElement('div');
        noTripsDiv.style.cssText = 'text-align:center; color:#888; padding: 40px; width: 100%;';
        noTripsDiv.textContent = 'No upcoming trips found';
        carouselContainer.appendChild(noTripsDiv);
        return;
      }

      // Show sample data notice
      const sampleNotice = document.createElement('div');
      sampleNotice.style.cssText = `
      background: #fff3cd;
      color: #856404;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      border: 1px solid #ffeaa7;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    `;
      sampleNotice.innerHTML = `
      <strong>📋 Sample Data Mode</strong><br>
      This is sample data for demonstration purposes.
      The actual data will load when the Google Apps Script is properly configured.
    `;
      carouselContainer.appendChild(sampleNotice);

      trips.forEach(trip => {
        console.log(`Processing sample trip with status: "${trip.status}"`);

        // Crear fila para tabla móvil
        const row = document.createElement("tr");
        row.innerHTML = `
        <td style="white-space: nowrap;">${formatDate(trip.startDate)}</td>
        <td style="white-space: nowrap;">${trip.origin}</td>
        <td style="white-space: nowrap;">${trip.destination}</td>
        <td style="white-space: nowrap;">${trip.price} CAD</td>
        <td>
          <div class="buttons-container">
            <span id="statusLabel-${trip.id}" class="status-label" data-status="${trip.status}">${trip.status}</span>
          </div>
        </td>
        <td>
          <div class="action-buttons">
            ${generateActionButtons(trip)}
          </div>
        </td>
      `;
        tbody.appendChild(row);
        console.log('Added row to table');

        // Crear tarjeta para carrusel desktop
        console.log('Creating sample trip card for carousel...');
        const tripCard = renderTripCard(trip);
        console.log('Sample trip card created:', tripCard);
        carouselContainer.appendChild(tripCard);
        console.log('Sample trip card added to carousel');

        // Crear tarjeta responsive para móvil
        const rideTypeImage = getRideTypeImage(trip.type);
        const rideTypeImageHtml = rideTypeImage ? `<img src="${rideTypeImage}" class="ride-type-icon" alt="ride type" style="width: 100px; height: 100px; transform: scaleX(-1);" />` : '';
        const rideTypeTitle = trip.type === 'Shared Ride' ? 'Shared Ride' : 'Personal Ride';

        // Check if status is Route_Confirmed to show playlist
        const showPlaylist = trip.status === 'Route_Confirmed' || trip.status === 'Confirmed';
        const playlistContainer = showPlaylist ? `
        <div class="playlist-list-container" id="playlist-container-mobile-${trip.id}">
          <div class="playlist-list-header">
            <h4 class="playlist-list-title">🎵 Commute Playlist</h4>
            <div class="playlist-list-controls">
              <button onclick="togglePlaylistSearch('mobile-${trip.id}')" class="playlist-list-btn">🎵 Add Songs</button>
              <button onclick="refreshPlaylist('mobile-${trip.id}')" class="playlist-list-btn">🔄 Refresh</button>
            </div>
          </div>

          <!-- YouTube Playlist List (not video) -->
          <div class="playlist-list-container" id="playlist-list-${trip.id}">
            <div class="playlist-loading">Loading playlist...</div>
          </div>

          <!-- Search Interface (hidden by default) -->
          <div class="playlist-search-container" id="playlist-search-mobile-${trip.id}" style="display: none;">
            <div class="search-form">
              <input type="text" id="search-input-mobile-${trip.id}" placeholder="Search for a song..." class="search-input">
              <input type="text" id="user-name-mobile-${trip.id}" placeholder="Your name" class="search-input">
              <button onclick="searchAndSubmitSong('mobile-${trip.id}')" class="search-btn">Search & Submit</button>
            </div>
            <div id="search-results-mobile-${trip.id}" class="search-results"></div>
          </div>

          <!-- Your Stops Section -->
          <div class="your-stops-container">
            <h5>📍 Your Stops</h5>
            <div class="stops-list">
              <div class="stop-item">
                <span class="stop-time">${trip.timeText || 'TBD'}</span>
                <span class="stop-location">${trip.origin}</span>
                <span class="stop-type">Pickup</span>
              </div>
              <div class="stop-item">
                <span class="stop-time">${trip.timeText ? addMinutes(trip.timeText, 30) : 'TBD'}</span>
                <span class="stop-location">${trip.destination}</span>
                <span class="stop-type">Dropoff</span>
              </div>
            </div>
          </div>
        </div>
      ` : '';

        const card = document.createElement("div");
        card.className = "responsive-card";
        card.innerHTML = `
        <div class="card-header">
          <div class="left-column">
            ${rideTypeImageHtml}
            <div class="status-label" id="statusLabel-${trip.id}" data-status="${trip.status}">${trip.status}</div>
          </div>
          <div class="right-column">
            <h3 class="ride-type-title">${rideTypeTitle}</h3>
            <div class="date-time-info">
              <div class="date-row">
                <img src="https://www.svgrepo.com/show/438428/date-round.svg" class="date-icon" alt="date" />
                <span class="date-text">${formatDate(trip.startDate)}</span>
              </div>
              <div class="time-row">
                <img src="https://static.vecteezy.com/system/resources/previews/017/259/098/non_2x/clock-icon-time-sign-free-png.png" class="time-icon" alt="time" />
                <span class="card-time">${trip.timeText || ''}</span>
              </div>
              <div class="price-section">
                <span class="trip-price">$${trip.price} CAD</span>
              </div>
            </div>
          </div>
        </div>
        <div class="trip-address-row">
          <span class="address-block">
            <span class="address-value">${trip.origin}</span>
          </span>
          <img src="../../public/image/Ruta.png" class="route-image" alt="route" />
          <span class="address-block">
            <span class="address-value">${trip.destination}</span>
          </span>
        </div>
        <div class="route-details" style="display:none;"></div>
        ${playlistContainer}
        <div class="action-buttons">
          ${generateActionButtons(trip)}
        </div>
      `;
        cardContainer.appendChild(card);
        console.log('Added responsive card to mobile container');
      });

      console.log('Sample data loaded successfully');
      console.log('Final carousel container children:', carouselContainer.children.length);
      console.log('Final card container children:', cardContainer.children.length);
    }

    // Function to search and submit songs
    async function searchAndSubmitSong(tripId) {
      const searchInput = document.getElementById(`search-input-${tripId}`);
      const userNameInput = document.getElementById(`user-name-${tripId}`);
      const resultsDiv = document.getElementById(`search-results-${tripId}`);

      const query = searchInput.value.trim();
      const userName = userNameInput.value.trim();

      if (!query || !userName) {
        alert('Please enter both a song search and your name');
        return;
      }

      // Show loading
      resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Searching...</div>';

      try {
        // Search YouTube
        const response = await fetch(
          `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(query)}&key=${CONFIG.YOUTUBE_API_KEY}&maxResults=5`
        );

        const data = await response.json();

        if (data.error) {
          throw new Error(data.error.message);
        }

        if (!data.items || data.items.length === 0) {
          resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No videos found. Try a different search term.</div>';
          return;
        }

        // Display results
        let html = '<h4>Search Results:</h4>';

        data.items.forEach((video, index) => {
          const thumbnail = video.snippet.thumbnails.medium || video.snippet.thumbnails.default;
          const escapedTitle = video.snippet.title.replace(/'/g, "\\'").replace(/"/g, '\\"');

          html += `
          <div style="display: flex; align-items: center; gap: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; background: white;">
            <img src="${thumbnail.url}" alt="${video.snippet.title}" style="width: 80px; height: 60px; border-radius: 4px; object-fit: cover;">
            <div style="flex: 1;">
              <h5 style="margin: 0 0 5px 0; font-size: 14px;">${video.snippet.title}</h5>
              <p style="margin: 0; font-size: 12px; color: #666;">${video.snippet.channelTitle}</p>
            </div>
            <button
              onclick="submitSongFromCard('${video.id.videoId}', '${escapedTitle}', '${userName}', '${tripId}')"
              style="background: #1B263B; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background-color 0.2s ease;"
              onmouseover="this.style.background='#415A77'"
              onmouseout="this.style.background='#1B263B'">
              Add to Playlist
            </button>
          </div>
        `;
        });

        resultsDiv.innerHTML = html;

      } catch (error) {
        console.error('Search error:', error);
        resultsDiv.innerHTML = `<div style="text-align: center; padding: 20px; color: #d32f2f;">Error searching for songs: ${error.message}</div>`;
      }
    }

    // Function to submit song from card
    async function submitSongFromCard(videoId, title, userName, tripId) {
      try {
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'Submitting...';
        button.disabled = true;

        // Use APIUtils for JSONP
        const apiUtils = new APIUtils(CONFIG.GOOGLE_APPS_SCRIPT.MAIN);
        const result = await apiUtils.makeApiCall(CONFIG.GOOGLE_APPS_SCRIPT.MAIN, {
          params: {
            action: 'submit_song',
            videoId: videoId,
            user: userName,
            userEmail: JSON.parse(localStorage.getItem('user')).email,
            timestamp: new Date().toISOString()
          }
        });

        if (result.success) {
          alert('Song submitted successfully! It will be reviewed and added to the playlist.');
          // Clear search results
          document.getElementById(`search-results-${tripId}`).innerHTML = '';
          // Hide search interface and show iframe
          togglePlaylistSearch(tripId);
        } else {
          alert('Error submitting song: ' + result.message);
        }
      } catch (error) {
        console.error('Submit error:', error);
        alert('Error submitting song: ' + error.message);
      } finally {
        // Restore button state
        const button = event.target;
        button.textContent = 'Add to Playlist';
        button.disabled = false;
      }
    }
  </script>

</body>

</html>
